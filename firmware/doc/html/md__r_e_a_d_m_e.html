<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NOP100: NOP100/firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NOP100
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">NOP100/firmware </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"> {NOP100.cpp```}</div>
<div class="line">complete, runnable, extensible firmware for</div>
<div class="line">[NOP100-based hardware](../hardware/README.md).</div>
<div class="line"> </div>
<div class="line">The NOP100 build framework consists of six C++ source files:</div>
<div class="line">```NOP100.cpp```,</div>
<div class="line">```module-libraries.inc```,</div>
<div class="line">```module-directives.inc```,</div>
<div class="line">```module-definitions.inc```,</div>
<div class="line">```module-setup.inc``` and</div>
<div class="line">```module-loop.inc```.</div>
<div class="line">Firmware for a specialised NMEA application is implemented by</div>
<div class="line">extending and modifying the ```.inc``` files to suit the requirements</div>
<div class="line">of the project in hand.</div>
<div class="line">Each ```.inc``` file includes documentary comments which explain</div>
<div class="line">how to structure a specialisation and the</div>
<div class="line">[SIM108 - NMEA 2000 switch input module](https://github.com/preeve9534/SIM108/)</div>
<div class="line">project is based on NOP100 and gives a working example of a real-world</div>
<div class="line">application built on top of NOP100.</div>
<div class="line"> </div>
<div class="line">If compiled and installed on NOP100 hardware the vanilla firmware</div>
<div class="line">will create an NMEA 2000 device with Class Code 10 (System Tools)</div>
<div class="line">and Function Code 130 (Diagnostic).</div>
<div class="line">The firmware supports the entry of configuration data (see below),</div>
<div class="line">but only the configuration data item that is used by NOP100 is the</div>
<div class="line">module instance setting.</div>
<div class="line"> </div>
<div class="line">## Module configuration</div>
<div class="line"> </div>
<div class="line">NOP100 treats persistent configuration data as a simple byte array and</div>
<div class="line">provides a user interface which allows the hardware DIL switch to be  </div>
<div class="line">used sequentially to specify a storage address and the value to be</div>
<div class="line">stored at that address.</div>
<div class="line">This restricts the configuration data cache to a size of 256 bytes with</div>
<div class="line">254 bytes available to the application.</div>
<div class="line">The Teensy microcontroller has a about 1KB of EEPROM available and if</div>
<div class="line">you want to access more than 256 bytes of this storage then you will</div>
<div class="line">need to override NOP100&#39;s simple configuration model with a more</div>
<div class="line">elaborate one of your own.</div>
<div class="line">If you do this, make sure that your application configuration data</div>
<div class="line">leaves address locations 0 and 1 for use by NOP100.</div>
<div class="line"> </div>
<div class="line">| Address | Saved value |</div>
<div class="line">| ---:    | :---        |</div>
<div class="line">| 0       | CAN source address. Not available for application use. |</div>
<div class="line">| 1       | Module instance number. Not available for application use. |</div>
<div class="line">| 2...    | Available for application use. |</div>
<div class="line"> </div>
<div class="line">Entry of configuration data into NOP100 requires a value to be set on</div>
<div class="line">the PCB&#39;s DIL switch and then confirmed by press and release of the PRG</div>
<div class="line">button.</div>
<div class="line">A short press of PRG signifies the entry of a data value; a long press</div>
<div class="line">of PRG signifies entry of an address and, in this latter case, the</div>
<div class="line">expectation is that address entry will promptly be followed by the</div>
<div class="line">entry of a data value which should be stored at the pre-set address.</div>
<div class="line"> </div>
<div class="line">If a value is entered without a preceeding address then the entered</div>
<div class="line">value is stored at address 1 and will become the module&#39;s new instance</div>
<div class="line">number.</div>
<div class="line"> </div>
<div class="line">Storage locations with an address greater than or equal to two are</div>
<div class="line">intended for application configuration data and entry of this data</div>
<div class="line">requires the entry of an address followed by entry of the value to be</div>
<div class="line">stored at this address.</div>
<div class="line"> </div>
<div class="line">When an address is entered, the transmit LED will flash rapidly</div>
<div class="line">indicating that the system is waiting for entry of a data value.</div>
<div class="line">If a data value is not entered within one minute the data entry protocol</div>
<div class="line">will self-cancel (the transmit LED will stop flashing).</div>
<div class="line"> </div>
<div class="line">In ```NOP100.cpp``` the configuration process is handled by the</div>
<div class="line">```prgButtonHandler(bool _state_, int _value_)``` function which is</div>
<div class="line">called each time the PRG button is operated.</div>
<div class="line">*state* will be true if the PRG button has been released or false if</div>
<div class="line">the PRG button has been pressed.</div>
<div class="line">In either case, *value* will be set to the current value read from the</div>
<div class="line">DIL switch.</div>
<div class="line"> </div>
<div class="line">You can override NOP100&#39;s built-in behaviour by overriding the button</div>
<div class="line">handler in ```module-declarations.inc```.</div>
<div class="line">For example, the following code disables configuration entirely:</div>
</div><!-- fragment --><p> #define PRG_BUTTON_HANDLER void prgButtonHandler(bool state, int value) { return; } </p><div class="fragment"><div class="line">## HOW TO</div>
<div class="line"> </div>
<div class="line">1. Create parent folder for your new application.</div>
</div><!-- fragment --><p> $&gt; mkdir n2k-projects $&gt; cd n2k-projects </p><div class="fragment"><div class="line">2. Clone a copy of the Arduino firmware build project and this</div>
<div class="line">   project into separate sub-folders.</div>
</div><!-- fragment --><p> $&gt; git clone <a href="https://github.com/preeve9534/firmware-factory">https://github.com/preeve9534/firmware-factory</a> $&gt; git clone <a href="https://github.com/preeve9534/NOP100">https://github.com/preeve9534/NOP100</a> </p><div class="fragment"><div class="line">3. Make a directory for your new project and populate it.</div>
</div><!-- fragment --><p> $&gt; mkdir myapp $&gt; cd myapp $&gt; cp ../NOP100/NOP100.cpp myapp.cpp $&gt; cp ../NOP100/*.inc . $&gt; cd .. </p><div class="fragment"><div class="line">You can now delete the NOP100 project.</div>
</div><!-- fragment --><p> rm -rf NOP100 </p><div class="fragment"><div class="line">4. Set up the build environment so that it points to your new</div>
<div class="line">   project.</div>
</div><!-- fragment --><p> $&gt; cd firmware-factory/sketch $&gt; rm src $&gt; ln -s ../../myapp src $&gt; cd ../.. ``` At this juncture you should be able to open the firmware-factory project in your preferred build environment (I use Code) and compile a firmware for your application which does nothing. Well, not very much.</p><ol type="1">
<li>Edit the <code>.inc</code> files downloaded at (3) to tailor and extend the module firmware to the requirements of your application. DO NOT MODIFY myapp.cpp. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
